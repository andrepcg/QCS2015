<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>QCS Insulin</title>

    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href="css/formValidation.min.css" rel="stylesheet">
    <style>

        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }
        .hero-unit {
            background: #E0E0E0;
        }
    </style>
</head>

<body>
<div class="container ">
    <div class="row">

        <div class="col-md-8">
            <ul id="myTab" class="nav nav-pills" role="tablist">
                <li role="presentation" class="active"><a href="#mealtimeinsulindose" aria-controls="home" role="mealtimeinsulindose" data-toggle="tab">Mealtime insulin dose</a></li>
                <li role="presentation"><a href="#backgroundinsulindose" aria-controls="home" role="backgroundinsulindose" data-toggle="tab">Background insulin dose</a></li>
                <li role="presentation"><a href="#personalinsulinsensivity" aria-controls="home" role="personalinsulinsensivity" data-toggle="tab">Personal insulin sensivity</a></li>
            </ul>
        </div>

        <div class="col-md-8 tab-content">
            <div role="tabpanel" id="mealtimeinsulindose" class="jumbotron tab-pane fade in active">
                <h3><strong>Mealtime insulin dose</strong></h3>

                <form class="form-horizontal" style="margin-top: 30px;" role="form">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Carbohydrate amount</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="carbohydrateAmount" placeholder="asd">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Carbohydrate to insulin ratio</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="carbohydrateToInsulinRatio" placeholder="dfg">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-4 control-label">Pre meal blood sugar</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="preMealBloodSugar" placeholder="ert">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-4 control-label">Target blood sugar</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="targetBloodSugar" placeholder="targetBloodSugar">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-4 control-label">Personal sensitivity</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="personalSensitivity" placeholder="personalSensitivity">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-offset-4 col-sm-8">

                            <label>
                                <input type="checkbox" name="explain"> Technical details
                            </label>

                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="submit" class="btn btn-primary btn-small pull-right">Submit</button>
                        </div>
                    </div>

                </form>
            </div>

            <div role="tabpanel" id="backgroundinsulindose" class="jumbotron tab-pane fade ">
                <h3><strong>Background insulin dose</strong></h3>

                <form class="form-horizontal" role="form" style="margin-top: 30px;">

                    <div class="form-group">
                        <label class="col-sm-3 control-label">Body weight</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="bodyWeight" placeholder="75kg">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-9">
                                <label>
                                    <input type="checkbox" name="explain"> Technical details
                                </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="submit" class="btn btn-primary btn-small pull-right">Submit</button>
                        </div>
                    </div>
                </form>
            </div>

            <div role="tabpanel" id="personalinsulinsensivity" class="jumbotron tab-pane fade">
                <h3><strong>Personal insulin sensivity</strong></h3>
                <form class="form-horizontal" style="margin-top: 30px;" role="form">

                    <div class="form-group">
                        <label class="col-sm-3 control-label">Personal activity level</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="physicalActivityLevel" placeholder="0-10">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">Physical activity samples</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="physicalActivitySamples" placeholder="4,3,8">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">Blood sugar samples</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="bloodSugarDropSamples" placeholder="50,27,32">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-9">
                            <label>
                                <input type="checkbox" name="explain"> Technical details
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="submit" class="btn btn-primary btn-small pull-right">Subscrever</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-md-4">

            <button class="btn btn-primary" id="waitingresponse" type="button" style="display: none;">
                Waiting response <i class="fa fa-spinner fa-spin"></i>
            </button>

            <button class="btn btn-warning" id="retrying" type="button" style="display: none;">
                <i class="fa fa-spinner fa-spin"></i> Failed, retrying...
            </button>

            <button class="btn btn-danger" id="failed" type="button" style="display: none;">
                <i class="fa fa-times"></i> Failed
            </button>



            <h2>Results</h2>
            <input class="form-control"  id="results">
        </div>

    </div>

    <div class="row">
        <div class="col-md-12">

                <h3>Details</h3>
                <textarea class="form-control" rows="20" id="xml" name="xml"></textarea>


        </div>
    </div>

</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/async/0.9.0/async.min.js"></script>
<script src="js/formValidation.min.js"></script>
<script src="js/framework/bootstrap.min.js"></script>

<script>
    /*

     Finally, here are some typical values that you may use to make the interface robust:
     backgroundInsulinDose
     bodyWeight entre 60kg e 120kg
     mealtimeInsulinDose
     carbohydrateAmount between 60g and 150g
     carbohydrateToInsulinRatio between 10g/unit and 15g/unit
     preMealBloodSugar between 120mg/dl and 250mg/dl
     targetBloodSugar between 80mg/dl and 120mg/dl
     personalSensitivity between 15mg/dl and 100mg/dl
     (Note: the median of 50mg/dl for 'personalSensitivity' corresponds to the median of 12g/unit for 'carbohydrateToInsulinRatio'.)

     personalSensitivityToInsulin
     physicalActivityLevel between 0 and 10 (no units)
     bloodSugarDropSamples between 15mg/dl and 100mg/dl


     */

    var parseDetails = function(data){
        // data.result -> resultado final
        // data.source -> lista
        $("#xml").text("");

        for(var i = 0; i < data.source.length; i++){
            var endpoint = data.source[i];
            $("#xml").append("Source: " + endpoint.endpoint + "\n");
            $("#xml").append("Response time: " + endpoint.responseTime + "\n");
            $("#xml").append("Result: " + endpoint.return + "\n\n");
        }
    };


    $( document ).ready(function() {

        $(document).bind("ajaxSend", function(){
            $("#waitingresponse").show();
        }).bind("ajaxComplete", function(){
            $("#waitingresponse").hide();
        });

        $('#backgroundinsulindose form').formValidation({
            framework: 'bootstrap',
            icon: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                bodyWeight: {
                    validators: {
                        notEmpty: {
                            message: 'O peso é necessário'
                        },
                        numeric: {
                            message: 'O peso deve ser um valor numérico'
                        },
                        between: {
                            min: 60,
                            max: 120,
                            message: 'O peso deve encontrar-se acima de 60kg e abaixo de 120'
                        }
                    }
                }
            }
        }).on('err.field.fv', function(e, data) {
            if (data.fv.getSubmitButton()) {
                data.fv.disableSubmitButtons(true);
            }
        })
        .on('success.field.fv', function(e, data) {
            if (data.fv.getSubmitButton()) {
                data.fv.disableSubmitButtons(false);
            }

        }).on('success.form.fv', function(e) {
            e.preventDefault();

            var data = {bodyWeight: $("#backgroundinsulindose input[name=bodyWeight]").val()};

            async.retry(3, function(cb, results){
                background_insulin_dose(data, function(err, result){
                    if(err) {
                        $("#retrying").show();
                        cb(err);
                    }
                    else
                        cb(null, result);
                });
            }, function(err, result) {

                if(err) {
                    console.error(err);
                    $("#failed").show();
                    $("#retrying").hide();
                }

                if(result) {
                    console.log(result);
                    $("#results").val(result.result);
                    parseDetails(result);
                    $("#retrying").hide();
                    $("#failed").hide();
                }
            });


        });

        function background_insulin_dose(data, cb){
            $.ajax({
                dataType: "json",
                url: "api/background_insulin_dose",
                data: data,
                success: function(result){
                    if(result.result == null)
                        return cb(new Error("Nao foi possivel determinar o resultado"), null);

                    return cb(null, result);
                }
            });
        }

        function personal_sensitivity_insulin(data, cb){
            $.ajax({
                dataType: "json",
                url: "api/personal_sensitivity_insulin",
                data: data,
                success: function(result){
                    if(result.result == null)
                        return cb(new Error("Nao foi possivel determinar o resultado"), null);

                    return cb(null, result);
                }
            });
        }

        function mealtime_insulin_dose(data, cb){
            $.ajax({
                dataType: "json",
                url: "api/mealtime_insulin_dose",
                data: data,
                success: function(result){
                    if(result.result == null)
                        return cb(new Error("Nao foi possivel determinar o resultado"), null);

                    return cb(null, result);
                }
            });
        }









        $('#personalinsulinsensivity form').formValidation({
            framework: 'bootstrap',
            icon: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                bodyWeight: {
                    validators: {
                        notEmpty: {
                            message: 'O peso é necessário'
                        },
                        numeric: {
                            message: 'O peso deve ser um valor numérico'
                        },
                        between: {
                            min: 60,
                            max: 120,
                            message: 'O peso deve encontrar-se acima de 60kg e abaixo de 120'
                        }
                    }
                },

                bloodSugarDropSamples: {
                    validators: {
                        notEmpty: {
                            message: 'É necessário inserir amostras dos níveis de glicose'
                        },
                        regexp: {
                            regexp: /^(\d,(\s)*)+\d(\s)*$/,
                            message: 'As amostras devem ser inseridas no formato 123,123,123'
                        }
                    }
                },

                physicalActivitySamples: {
                    validators: {
                        notEmpty: {
                            message: 'É necessário inserir amostras dos níveis de actividade'
                        },
                        regexp: {
                            regexp: /^(\d,(\s)*)+\d(\s)*$/,
                            message: 'As amostras devem ser inseridas no formato 123,123,123'
                        }
                    }
                }


            }
        }).on('err.field.fv', function(e, data) {
            if (data.fv.getSubmitButton()) {
                data.fv.disableSubmitButtons(true);
            }
        })
        .on('success.field.fv', function(e, data) {
            if (data.fv.getSubmitButton()) {
                data.fv.disableSubmitButtons(false);
            }

        }).on('success.validator.fv', function(e, data) {
            // data.field     --> The field name
            // data.element   --> The field element
            // data.result    --> The result returned by the validator
            // data.validator --> The validator name

            var physicalSamples = $("#personalinsulinsensivity input[name=physicalActivitySamples]").val().split(",");
            var bloodSamples = $("#personalinsulinsensivity input[name=bloodSugarDropSamples]").val().split(",");

            if (data.field === 'physicalActivitySamples' || data.field === 'bloodSugarDropSamples' && (physicalSamples.length != bloodSamples.length))
            {

                $("#personalinsulinsensivity input[name=physicalActivitySamples]").closest(".form-group").removeClass('has-success').addClass('has-error');
                $("#personalinsulinsensivity input[name=bloodSugarDropSamples]").closest(".form-group").removeClass('has-success').addClass('has-error');

/*
                // The userName field passes the remote validator
                data.element                    // Get the field element
                    .closest('.form-group')     // Get the field parent

                    // Add has-warning class
                    .removeClass('has-success')
                    .addClass('has-error')

                    // Show message
                    .find('small[data-fv-validator="remote"][data-fv-for="physicalActivitySamples"] small[data-fv-validator="remote"][data-fv-for="bloodSugarDropSamples"]')
                        .show();

                data.element
                    .closest('.form-group')

                    // Add has-warning class
                    .removeClass('has-success')
                    .addClass('has-error')

                    // Show message
                    .find('small[data-fv-validator="remote"][data-fv-for="bloodSugarDropSamples"]').show();
                    */
            }
            console.log("success");


        })
        // This event will be triggered when the field doesn't pass given validator
        .on('err.validator.fv', function(e, data) {
            // We need to remove has-warning class
            // when the field doesn't pass any validator
            if (data.field === 'physicalActivitySamples' || data.field === 'bloodSugarDropSamples') {
                data.element.closest('.form-group').removeClass('has-error');
            }

            console.log("err")

        }).on('success.form.fv', function(e) {
            // Prevent form submission
            e.preventDefault();

            var physicalSamples = $("#personalinsulinsensivity input[name=physicalActivitySamples]").val().split(",");
            var bloodSamples = $("#personalinsulinsensivity input[name=bloodSugarDropSamples]").val().split(",");

                    var data = {
                        physicalActivityLevel: $("#personalinsulinsensivity input[name=physicalActivityLevel]").val(),
                        physicalActivitySamples: physicalSamples,
                        bloodSugarDropSamples: bloodSamples
                    };

                    async.retry(3, function(cb, results){
                        personal_sensitivity_insulin(data, function(err, result){
                            if(err) {
                                $("#retrying").show();
                                cb(err);
                            }
                            else
                                cb(null, result);
                        });
                    }, function(err, result) {

                        if(err) {
                            console.error(err);
                            $("#failed").show();
                            $("#retrying").hide();
                        }

                        if(result) {
                            console.log(result);
                            $("#results").val(result.result);
                            parseDetails(result);
                            $("#retrying").hide();
                            $("#failed").hide();
                        }
                    });

        });




        $("#mealtimeinsulindose form").submit(function( event ) {
            event.preventDefault();
            $.ajax({
                dataType: "json",
                url: "api/mealtime_insulin_dose",
                data: {
                    carbohydrateAmount: $("#mealtimeinsulindose input[name=carbohydrateAmount]").val(),
                    carbohydrateToInsulinRatio: $("#mealtimeinsulindose input[name=carbohydrateToInsulinRatio]").val(),
                    preMealBloodSugar: $("#mealtimeinsulindose input[name=preMealBloodSugar]").val(),
                    targetBloodSugar: $("#mealtimeinsulindose input[name=targetBloodSugar]").val(),
                    personalSensitivity: $("#mealtimeinsulindose input[name=personalSensitivity]").val()
                },
                success: function(result){
                    console.log(result);
                    $("#results").val(result.result);
                }
            });
        });
    });
</script>

</body>
</html>